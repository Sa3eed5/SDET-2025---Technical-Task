version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:18.17-browsers

jobs:
  run-ui-tests:
    executor: node-executor
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: Install Google Chrome
          command: |
            sudo apt update
            sudo apt install -y wget gnupg2
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            echo 'deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main' | sudo tee /etc/apt/sources.list.d/google-chrome.list
            sudo apt update
            sudo apt install -y google-chrome-stable

      - run:
          name: Install dependencies
          command: npm install

      - run:
          name: Run UI tests
          command: npm run test:ui

      - store_artifacts:
          path: UI-test/tests_output
          destination: ui-test-report

  run-api-tests:
    executor: node-executor
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: Install dependencies
          command: npm install

      - run:
          name: Start mock API server
          command: |
            node API-tests/mock-user-auth/index.js > server.log 2>&1 &
            sleep 5
            cat server.log

      - run:
          name: check if server is reachable
          command: |
            sleep 3
            curl -i http://localhost:3000 || echo "Server is not up"
      - run:
          name: Wait for API server to be ready
          command: npx wait-on http://localhost:3000 --timeout=30000


      - run:
          name: Run API tests
          command: npm run test:api

      - store_artifacts:
          path: API-tests/mock-user-auth/components/mock/routes/report.html
          destination: api-test-report

workflows:
  version: 2
  run-tests:
    jobs:
      - run-api-tests
        
